<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>@topia/multiplayer Inspector</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #1a1a2e;
      color: #e0e0e0;
      padding: 20px;
    }
    h1 { color: #00d4ff; margin-bottom: 20px; font-size: 24px; }
    h2 { color: #00d4ff; margin-bottom: 12px; font-size: 18px; }
    .badge {
      display: inline-block;
      background: #00d4ff;
      color: #1a1a2e;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: bold;
      margin-left: 8px;
    }
    .room-list { display: flex; flex-wrap: wrap; gap: 16px; margin-bottom: 24px; }
    .room-card {
      background: #16213e;
      border: 1px solid #0f3460;
      border-radius: 8px;
      padding: 16px;
      min-width: 280px;
      cursor: pointer;
      transition: border-color 0.2s;
    }
    .room-card:hover, .room-card.active { border-color: #00d4ff; }
    .room-card h3 { margin-bottom: 8px; }
    .stat-row { display: flex; justify-content: space-between; margin: 4px 0; font-size: 14px; }
    .stat-label { color: #888; }
    table { width: 100%; border-collapse: collapse; margin-top: 8px; }
    th, td { padding: 8px 12px; text-align: left; border-bottom: 1px solid #0f3460; }
    th { color: #00d4ff; font-size: 13px; text-transform: uppercase; }
    td { font-family: 'SF Mono', Monaco, monospace; font-size: 13px; }
    .bot-tag { color: #ff6b6b; font-size: 11px; }
    #detail { display: none; }
    #detail.visible { display: block; }
    .controls { margin: 16px 0; display: flex; align-items: center; gap: 16px; }
    button {
      background: #0f3460;
      color: #00d4ff;
      border: 1px solid #00d4ff;
      padding: 6px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
    }
    button:hover { background: #00d4ff; color: #1a1a2e; }
    .status { font-size: 13px; color: #888; }
    #error { color: #ff6b6b; margin: 16px 0; display: none; }
  </style>
</head>
<body>
  <h1>@topia/multiplayer Inspector</h1>
  <div id="error"></div>
  <div class="status" id="status">Connecting...</div>

  <h2>Rooms</h2>
  <div class="room-list" id="room-list"></div>

  <div id="detail">
    <h2>Entities <span class="badge" id="entity-count">0</span></h2>
    <table>
      <thead>
        <tr><th>ID</th><th>Type</th><th>Bot</th><th>Schema</th></tr>
      </thead>
      <tbody id="entity-table"></tbody>
    </table>

    <h2 style="margin-top: 24px;">Stats</h2>
    <div id="stats-panel"></div>

    <div class="controls">
      <button id="btn-refresh">Refresh</button>
      <span class="status" id="last-update"></span>
    </div>
  </div>

  <script>
    const API_BASE = window.location.origin;
    let selectedRoom = null;

    async function fetchJSON(path) {
      const res = await fetch(API_BASE + path);
      if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
      return res.json();
    }

    async function loadRooms() {
      try {
        const rooms = await fetchJSON('/rooms');
        const list = document.getElementById('room-list');
        list.innerHTML = '';
        document.getElementById('status').textContent =
          `${rooms.length} room(s) active`;

        rooms.forEach(room => {
          const card = document.createElement('div');
          card.className = 'room-card' + (selectedRoom === room.roomId ? ' active' : '');
          card.innerHTML = `
            <h3>${room.gameName} <span class="badge">${room.playerCount} players</span></h3>
            <div class="stat-row"><span class="stat-label">Room ID</span><span>${room.roomId}</span></div>
            <div class="stat-row"><span class="stat-label">Entities</span><span>${room.entityCount}</span></div>
            <div class="stat-row"><span class="stat-label">Ticks</span><span>${room.tickCount}</span></div>
            <div class="stat-row"><span class="stat-label">Uptime</span><span>${(room.uptimeMs / 1000).toFixed(1)}s</span></div>
          `;
          card.onclick = () => selectRoom(room.roomId);
          list.appendChild(card);
        });
      } catch (err) {
        showError(err.message);
      }
    }

    async function selectRoom(roomId) {
      selectedRoom = roomId;
      document.getElementById('detail').className = 'visible';
      await Promise.all([loadEntities(roomId), loadStats(roomId)]);
      loadRooms(); // refresh active state
    }

    async function loadEntities(roomId) {
      try {
        const entities = await fetchJSON(`/rooms/${roomId}/entities`);
        document.getElementById('entity-count').textContent = entities.length;
        const tbody = document.getElementById('entity-table');
        tbody.innerHTML = '';
        entities.forEach(e => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${e.id}</td>
            <td>${e.type}</td>
            <td>${e.isBot ? '<span class="bot-tag">BOT</span>' : ''}</td>
            <td>${JSON.stringify(e.schema)}</td>
          `;
          tbody.appendChild(tr);
        });
      } catch (err) {
        showError(err.message);
      }
    }

    async function loadStats(roomId) {
      try {
        const stats = await fetchJSON(`/rooms/${roomId}/stats`);
        document.getElementById('stats-panel').innerHTML = `
          <div class="stat-row"><span class="stat-label">Avg Tick</span><span>${stats.avgTickDurationMs.toFixed(2)}ms</span></div>
          <div class="stat-row"><span class="stat-label">Max Tick</span><span>${stats.maxTickDurationMs.toFixed(2)}ms</span></div>
          <div class="stat-row"><span class="stat-label">Entities</span><span>${stats.entityCount}</span></div>
          <div class="stat-row"><span class="stat-label">Players</span><span>${stats.playerCount}</span></div>
        `;
        document.getElementById('last-update').textContent =
          `Updated ${new Date().toLocaleTimeString()}`;
      } catch (err) {
        showError(err.message);
      }
    }

    function showError(msg) {
      const el = document.getElementById('error');
      el.textContent = msg;
      el.style.display = 'block';
      setTimeout(() => el.style.display = 'none', 5000);
    }

    document.getElementById('btn-refresh').onclick = () => {
      if (selectedRoom) selectRoom(selectedRoom);
    };

    // Auto-refresh every 2 seconds
    loadRooms();
    setInterval(loadRooms, 2000);
  </script>
</body>
</html>
